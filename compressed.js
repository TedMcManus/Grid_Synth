var w,col,x=[],y=[];let yscale=.5,xscale=.8,fund=220,N,monoSynth,polySynth,EDO;EDO=12;let active_notes=[],place1=150,gridnumx=14,gridnumy=4,filter_envelope=new p5.Envelope,metaharmonicity,harmonicity,fenv_is_on=!0,depth=1e3,j_mult=4,i_mult=3,fundamental,RVB,DLY,DLYtype=0,Font;function preload(){Font=loadFont("Assets/OSANS.ttf")}let keygrid=[["1","2","3","4","5","6","7","8","9","0","-","="],["q","w","e","r","t","y","u","i","o","p","[","]"],["a","s","d","f","g","h","j","k","l",";","'"],["z","x","c","v","b","n","m",",",".","/"]],keystates=[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]];function setup(){col=initialize(col),createCanvas(windowWidth,windowHeight,WEBGL),textFont(Font),w=windowWidth/23,offset=w/4;for(var e=0;e<gridnumx;e++)for(var t=0;t<gridnumy;t++)x[e]=(w+e*w)/xscale+offset,y[t]=(w+t*w)/yscale;monoSynth=new p5.MonoSynth("sawtooth"),polySynth=new p5.PolySynth,polySynth.AudioVoice=monoSynth,userStartAudio(),translate(-width/2,-height/2),H=windowHeight,Hstep=H/792,W=windowWidth,Wstep=W/1536,Nx=20,Ny=windowHeight-windowHeight/10,N=createInput("Cardinality"),N.position(Nx,Ny-33*Hstep),N.size(70),N.elt.value=12,fundamental=createInput(""),fundamental.position(place1*Wstep+225*Wstep+240*Wstep,Ny+35*Hstep),fundamental.size(70),fundamental.elt.value=fund,fundamental.input(fund_update),harmonicity=createSelect("HARMONICITY"),harmonicity.option("Scalar"),harmonicity.option("Intermediate"),harmonicity.option("Chordal"),harmonicity.selected="Chordal",harmonicity.position(Nx,Ny+12*Hstep),metaharmonicity=createSelect("METAHARMONICITY"),metaharmonicity.option("Scalar (1&2)"),metaharmonicity.option("Inter (2&3)"),metaharmonicity.option("Chordal (1&3)"),metaharmonicity.selected="Inter (2&3)",metaharmonicity.position(Nx,Ny+50*Hstep),fill("white"),fATTACK=createSlider(0,5,.5,.1),fATTACK.position(450*Wstep,H-105*Hstep),fATTACK.style("width","150px"),fATTACK.mouseReleased(fenv),fDECAY=createSlider(0,5,1,.1),fDECAY.position(450*Wstep,H-85*Hstep),fDECAY.style("width","150px"),fDECAY.mouseReleased(fenv),fSUSTAIN=createSlider(0,1,1,.1),fSUSTAIN.position(450*Wstep,H-65*Hstep),fSUSTAIN.style("width","150px"),fSUSTAIN.mouseReleased(fenv),fRELEASE=createSlider(0,5,1.5,.1),fRELEASE.position(450*Wstep,H-45*Hstep),fRELEASE.style("width","150px"),fRELEASE.mouseReleased(fenv),fLEVEL=createSlider(0,3e3,1e3,100),fLEVEL.position(450*Wstep,H-25*Hstep),fLEVEL.style("width","150px"),fLEVEL.mouseReleased(fenv),RVBtime=createSlider(0,10,5,.1),RVBtime.position(1e3*Wstep,H-105*Hstep),RVBtime.style("width","100px"),RVBtime.mouseReleased(RVB_UPDATE),RVBDecay=createSlider(1,10,2,.1),RVBDecay.position(1e3*Wstep,H-85*Hstep),RVBDecay.style("width","100px"),RVBDecay.mouseReleased(RVB_UPDATE),RVBDRYWET=createSlider(0,1,0,.05),RVBDRYWET.position(1e3*Wstep,H-65*Hstep),RVBDRYWET.style("width","100px"),RVBDRYWET.mouseReleased(RVB_UPDATE),DLYFB=createSlider(0,.99,0,.01),DLYFB.position(800*Wstep,H-105*Hstep),DLYFB.style("width","100px"),DLYFB.mouseReleased(DLY_UPDATE),DLYtime=createSlider(0,.99,.5,.01),DLYtime.position(800*Wstep,H-85*Hstep),DLYtime.style("width","100px"),DLYtime.mouseReleased(DLY_UPDATE),DLYleft=createSlider(0,.99,.5,.01),DLYleft.position(800*Wstep,H-65*Hstep),DLYleft.style("width","100px"),DLYleft.mouseReleased(DLY_UPDATE),DLYright=createSlider(0,.99,.5,.01),DLYright.position(800*Wstep,H-45*Hstep),DLYright.style("width","100px"),DLYright.mouseReleased(DLY_UPDATE),fenv(),ATTACK=createSlider(0,5,.5,.1),ATTACK.position(220*Wstep,H-90*Hstep),ATTACK.style("width","150px"),ATTACK.mouseReleased(env),DECAY=createSlider(0,5,1,.1),DECAY.position(220*Wstep,H-70*Hstep),DECAY.style("width","150px"),DECAY.mouseReleased(env),SUSTAIN=createSlider(0,1,1,.1),SUSTAIN.position(220*Wstep,H-50*Hstep),SUSTAIN.style("width","150px"),SUSTAIN.mouseReleased(env),RELEASE=createSlider(0,5,1.5,.1),RELEASE.position(220*Wstep,H-30*Hstep),RELEASE.style("width","150px"),RELEASE.mouseReleased(env),WAVE=createSelect("WAVE"),WAVE.option("sine"),WAVE.option("triangle"),WAVE.option("sawtooth"),WAVE.option("square"),WAVE.position(place1*Wstep+225*Wstep+240*Wstep,H-90*Hstep),WAVE.changed(update_wave),F=new p5.Filter,polySynth.disconnect(),polySynth.connect(F),F.setType("lowpass"),F.set(5e3,10),F.freq(filter_envelope),filter_envelope.aLevel=depth,F.disconnect(),RVB=new p5.Reverb,DLY=new p5.Delay,DLYbutton=createButton("Mono/Stereo"),DLYbutton.position(800*Wstep,H-137*Hstep),DLYbutton.mousePressed(DLYflip),DLY.process(F),RVB.process(DLY),DLY.disconnect(),F.connect(RVB),DLY.connect(RVB),DLY_UPDATE(),RVB_UPDATE(),fenvbutton=createButton("On/Off"),fenvbutton.position(place1*Wstep+225*Wstep+150,H-137*Hstep),fenvbutton.mousePressed(fenvflip),background(10,0,10),textSize(20),fill("white"),text("Release",place1*Wstep,H-15*Hstep),text("Sustain",place1*Wstep,H-35*Hstep),text("Decay",place1*Wstep,H-55*Hstep),text("Attack",place1*Wstep,H-75*Hstep),text("Depth",place1*Wstep+225*Wstep,H-10*Hstep),text("Release",place1*Wstep+225*Wstep,H-30*Hstep),text("Sustain",place1*Wstep+225*Wstep,H-50*Hstep),text("Decay",place1*Wstep+225*Wstep,H-70*Hstep),text("Attack",place1*Wstep+225*Wstep,H-90*Hstep),text("Dry/Wet",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-50*Hstep),text("Decay",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-70*Hstep),text("Time",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-90*Hstep),text("Time",place1*Wstep+225*Wstep+345*Wstep,H-70*Hstep),text("FB",place1*Wstep+225*Wstep+345*Wstep,H-90*Hstep),text("(Right)",place1*Wstep+225*Wstep+345*Wstep,H-30*Hstep),text("(Left)",place1*Wstep+225*Wstep+345*Wstep,H-50*Hstep),fill(255,50,100),text("Amp Envelope",place1*Wstep,H-100*Hstep),text("Filter Envelope",place1*Wstep+225*Wstep,H-120*Hstep),text("Reverb",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-120*Hstep),text("Delay",place1*Wstep+225*Wstep+345*Wstep,H-120*Hstep),text("Cardinality",Nx,H-120),text("Harmonicity",Nx,H-73),text("Wave Type",place1*Wstep+225*Wstep+235*Wstep,H-100*Hstep),text("Fund (Hz)",place1*Wstep+225*Wstep+235*Wstep,H-48*Hstep),noLoop()}function initialize(e){for(var t=0;t<gridnumx;t++)for(var i=0;i<gridnumy;i++)e[i][t]=!0;return e}function RVB_UPDATE(){RVB.drywet(RVBDRYWET.value()),RVB.set(RVBtime.value(),RVBDecay.value())}function DLY_UPDATE(){DLY.process(F,DLYtime.value(),DLYFB.value()),"pingPong"==DLYtype&&(DLY.rightDelay.delayTime.value=DLYright.value(),DLY.leftDelay.delayTime.value=DLYleft.value())}function DLYflip(){0==DLYtype?(DLYtype="pingPong",DLYbutton.style("background-color",color(25,23,200,50)),DLY.rightDelay.delayTime.value=DLYright.value(),DLY.leftDelay.delayTime.value=DLYleft.value()):(DLYtype=0,DLY.setType(0),DLYbutton.style("background-color",color("white")),DLY.rightDelay.delayTime.value=DLYtime.value(),DLY.leftDelay.delayTime.value=DLYtime.value())}function fund_update(){fund=int(fundamental.elt.value)}function fenvflip(){fenv_is_on=!fenv_is_on,fenv_is_on&&fenvbutton.style("background-color",color("white")),fenv_is_on||fenvbutton.style("background-color",color(25,23,200,50))}function getValue(){return val=int(N.value()),isNaN(val)&&(val=12),val}function draw(){translate(-width/2,-height/2),rectMode(CENTER),stroke(0),ystep=100/y.length,xstep=100/x.length,fund_update(),DLY_UPDATE(),keyIsDown(LEFT_ARROW)&&(r=F.res(),F.res(r-1)),keyIsDown(RIGHT_ARROW)&&(r=F.res(),F.res(r+1)),keyIsDown(UP_ARROW)&&(F.biquad.frequency.value+=50),keyIsDown(DOWN_ARROW)&&(F.biquad.frequency.value-=50);for(var e=0;e<y.length;e++)for(var t=0;t<x.length;t++){keyIsPressed||(col=initialize(col)),filler=[150+xstep*t,80,100+ystep*e],inv_filler=[155-xstep*t,135-ystep*e/2,250],col[y.length-e-1][t]?fill(filler):fill("black"),ellipse(x[t],y[y.length-e-1],w,w),textSize(20),fill(inv_filler);var i=e*j_mult+t*i_mult;text(i,x[t]-w/8,y[y.length-e-1]+w/8)}}function env(){polySynth.setADSR(ATTACK.value(),DECAY.value(),SUSTAIN.value(),RELEASE.value())}function fenv(){filter_envelope.setADSR(fATTACK.value(),fDECAY.value(),fSUSTAIN.value(),fRELEASE.value()),filter_envelope.setRange(fLEVEL.value(),0)}function update_wave(){for(var e=0;e<polySynth.audiovoices.length;e++)polySynth.audiovoices[e].oscillator.setType(WAVE.selected())}function fastfactor(e){let t=[];for(;e%2==0;)e/=2,append(t,2);for(var i=3;i<=e;i+=2)for(;e%i==0;)append(t,i),e/=i;return t=[...new Set(t)],t}function powerlist(e){for(out=[],n=getValue()/2,i=0;i<e.length;i++){for(tmp=e[i],j=1,out_ni=[];pow(tmp,j)<n;)append(out_ni,pow(tmp,j)),j++;append(out,out_ni)}return out}function frqcalc(e,t){return power_list=powerlist(fastfactor(getValue())),3==power_list.length&&(power_list=metaheuristic(power_list),console.log("Invoking Metaheuristic")),[j_mult,i_mult]=heuristic(power_list),fund*pow(2,(-j_mult*e+i_mult*t)/getValue())}function heuristic(e){if(2==e.length)return selector=harmonicity.elt.selectedIndex,i_arr=e[0],j_arr=e[1],0==selector&&(j_out=j_arr[0],i_out=i_arr[0]),1==selector&&(j_out=j_arr[floor((j_arr.length-1)/2)],i_out=i_arr[floor((i_arr.length-1)/2)]),2==selector&&(j_out=j_arr[j_arr.length-1],i_out=i_arr[i_arr.length-1]),[j_out,i_out]}function metaheuristic(e){return console.log(e),selector=metaharmonicity.elt.selectedIndex,0==selector&&(j_out=e[1],i_out=e[0]),1==selector&&(j_out=e[2],i_out=e[1]),2==selector&&(j_out=e[2],i_out=e[0]),[i_out,j_out]}function keyPressed(){if("ArrowLeft"==key)return r=F.res(),void F.res(r-10);if("ArrowRight"==key)return r=F.res(),void F.res(r+10);if("ArrowUp"!=key)if("ArrowDown"!=key){if(" "==key)return filter_envelope.triggerAttack(),void console.log("filter envelope open");fenv_is_on&&filter_envelope.triggerAttack(),arr=locate_key(key),key_x=arr[0],key_y=arr[1],keystates[key_y][key_x]=1,col[key_y][key_x]=!col[key_y][key_x],notearr=get_notes(),l=active_notes.length,i=key_x,j=key_y,frqtotest=frqcalc(j,i),append(active_notes,frqtotest),polySynth.audiovoices[l].triggerAttack(frqtotest),redraw()}else F.biquad.frequency.value-=500;else F.biquad.frequency.value+=500}function keyReleased(){if(" "!=key){if(fenv_is_on&&filter_envelope.triggerRelease(),arr=locate_key(key),key_x=arr[0],key_y=arr[1],col[key_y][key_x]=!col[key_y][key_x],i=key_x,j=key_y,!keyIsPressed)return polySynth.noteRelease(),active_notes=[],clear_all(),void redraw();notearr=get_notes(),1==keystates[key_y][key_x]&&(keystates[key_y][key_x]=0,i=key_x,j=key_y,frqtotest=frqcalc(j,i),ind=active_notes.lastIndexOf(frqtotest),active_notes.splice(ind,1),polySynth.audiovoices[ind].triggerRelease()),redraw()}else filter_envelope.triggerRelease()}function mod(e,t){return(e%t+t)%t}function locate_key(e){let t,i;for(var o=0;o<=3;o++)keygrid[o].includes(e)&&(t=o);return 0==t&&(i=keygrid[0].indexOf(e)),1==t&&(i=keygrid[1].indexOf(e)),2==t&&(i=keygrid[2].indexOf(e)),3==t&&(i=keygrid[3].indexOf(e)),[i,t]}function get_notes(){notearr=[];for(var e=0;e<=3;e++){jmax=keygrid[e].length;for(var t=0;t<jmax;t++)1==keystates[e][t]&&append(notearr,[e,t])}return notearr}function clear_all(){notearr=[];for(var e=0;e<=3;e++){jmax=keygrid[e].length;for(var t=0;t<jmax;t++)keystates[e][t]=0}}col=[[],[],[],[]];