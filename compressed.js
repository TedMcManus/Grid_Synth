var w,col,x=[],y=[];let yscale=.55,xscale=.8,fund=220,N,monoSynth,polySynth,EDO;EDO=12;let active_notes=[],place1=150,gridnumx=12,gridnumy=4,keyboardscaling=25,filter_envelope=new p5.Envelope,metaharmonicity,harmonicity,fenv_is_on=!0,depth=1e3,j_mult=4,i_mult=3,fundamental,RVB,DLY,DLYtype=0,reload,Iguess,Jguess,Font;function preload(){Font=loadFont("Assets/OSANS.ttf")}let row1hor,row2hor,row3hor,row4hor,row5hor,row6hor,Wstep,Hstep,offset,bottom,keygrid=[["1","2","3","4","5","6","7","8","9","0","-","="],["q","w","e","r","t","y","u","i","o","p","[","]"],["a","s","d","f","g","h","j","k","l",";","'","Enter"],["z","x","c","v","b","n","m",",",".","/"]],keystates=[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]];function setup(){col=initialize(col),createCanvas(windowWidth,windowHeight,WEBGL),textFont(Font),w=windowWidth/23,offset=w/8;for(var e=0;e<gridnumy;e++)for(var t=0;t<gridnumx;t++)x[t]=(w+t*w)/xscale+offset,y[e]=(w+e*w)/yscale;monoSynth=new p5.MonoSynth("sawtooth"),polySynth=new p5.PolySynth,polySynth.AudioVoice=monoSynth,userStartAudio(),translate(-width/2,-height/2),H=windowHeight,Hstep=H/650,W=windowWidth,Wstep=W/1550,slidersize=windowWidth/12,slider_width=slidersize.toString()+"px",selectwidth=windowWidth/15,select_width=selectwidth.toString()+"px",row1hor=W/500,row2hor=W/20*3,row3hor=W/20*6,row4hor=W/20*9,row5hor=W/20*12,row6hor=W/20*15,offset=W/22+5,bottom=windowHeight-windowHeight/8,N=createInput("Cardinality"),N.position(row1hor,bottom-65*Hstep),N.size(70),N.elt.value=12,ent=createButton("Load"),ent.position(row1hor+40*Wstep,bottom-65*Hstep),ent.mousePressed(reloadfunc),ent.size(50,slider_width),harmonicity=createSelect("HARMONICITY"),harmonicity.option("Scalar"),harmonicity.option("Intermediate"),harmonicity.option("Chordal"),harmonicity.elt.selectedIndex=2,harmonicity.style("width",select_width),harmonicity.position(row1hor,bottom-10*Hstep),metaharmonicity=createSelect("METAHARMONICITY"),metaharmonicity.option("Scalar (1&2)"),metaharmonicity.option("Inter (2&3)"),metaharmonicity.option("Chordal (1&3)"),metaharmonicity.selected="Inter (2&3)",metaharmonicity.style("width",select_width),metaharmonicity.position(row1hor,bottom+45*Hstep),ATTACK=createSlider(0,5,.5,.1),ATTACK.position(row2hor,H-105*Hstep),ATTACK.style("width",slider_width),ATTACK.mouseReleased(amp_env),DECAY=createSlider(0,5,1,.1),DECAY.position(row2hor,H-85*Hstep),DECAY.style("width",slider_width),DECAY.mouseReleased(amp_env),SUSTAIN=createSlider(0,1,1,.1),SUSTAIN.position(row2hor,H-65*Hstep),SUSTAIN.style("width",slider_width),SUSTAIN.mouseReleased(amp_env),RELEASE=createSlider(0,5,1.5,.1),RELEASE.position(row2hor,H-45*Hstep),RELEASE.style("width",slider_width),RELEASE.mouseReleased(amp_env),fill("white"),fATTACK=createSlider(0,5,.5,.1),fATTACK.position(row3hor,H-105*Hstep),fATTACK.style("width",slider_width),fATTACK.mouseReleased(fenv),fDECAY=createSlider(0,5,1,.1),fDECAY.position(row3hor,H-85*Hstep),fDECAY.style("width",slider_width),fDECAY.mouseReleased(fenv),fSUSTAIN=createSlider(0,1,1,.1),fSUSTAIN.position(row3hor,H-65*Hstep),fSUSTAIN.style("width",slider_width),fSUSTAIN.mouseReleased(fenv),fRELEASE=createSlider(0,5,1.5,.1),fRELEASE.position(row3hor,H-45*Hstep),fRELEASE.style("width",slider_width),fRELEASE.mouseReleased(fenv),fLEVEL=createSlider(0,3e3,1e3,100),fLEVEL.position(row3hor,H-25*Hstep),fLEVEL.style("width",slider_width),fLEVEL.mouseReleased(fenv),fenvbutton=createButton("On/Off"),fenvbutton.position(row3hor+50,H-137*Hstep),fenvbutton.mousePressed(fenvflip),WAVE=createSelect("WAVE"),WAVE.option("sine"),WAVE.option("triangle"),WAVE.option("sawtooth"),WAVE.option("square"),WAVE.position(row4hor-offset/2,H-105*Hstep),WAVE.changed(update_wave),WAVE.selected("triangle"),fundamental=createInput(""),fundamental.position(row4hor-offset/2,bottom+35*Hstep),fundamental.size(70),fundamental.elt.value=fund,fundamental.input(fund_update),FXwidth=slider_width,DLYFB=createSlider(0,.99,0,.01),DLYFB.position(row5hor,H-105*Hstep),DLYFB.style("width",FXwidth),DLYFB.mouseReleased(DLY_UPDATE),DLYtime=createSlider(0,.99,.5,.01),DLYtime.position(row5hor,H-85*Hstep),DLYtime.style("width",FXwidth),DLYtime.mouseReleased(DLY_UPDATE),DLYleft=createSlider(0,.99,.5,.01),DLYleft.position(row5hor,H-65*Hstep),DLYleft.style("width",FXwidth),DLYleft.mouseReleased(DLY_UPDATE),DLYright=createSlider(0,.99,.5,.01),DLYright.position(row5hor,H-45*Hstep),DLYright.style("width",FXwidth),DLYright.mouseReleased(DLY_UPDATE),DLYbutton=createButton("Mono/Stereo"),DLYbutton.position(row5hor,H-140*Hstep),DLYbutton.mousePressed(DLYflip),RVBtime=createSlider(0,10,5,.1),RVBtime.position(row6hor,H-105*Hstep),RVBtime.style("width",FXwidth),RVBtime.mouseReleased(RVB_UPDATE),RVBDecay=createSlider(1,10,2,.1),RVBDecay.position(row6hor,H-85*Hstep),RVBDecay.style("width",FXwidth),RVBDecay.mouseReleased(RVB_UPDATE),RVBDRYWET=createSlider(0,1,0,.05),RVBDRYWET.position(row6hor,H-65*Hstep),RVBDRYWET.style("width",FXwidth),RVBDRYWET.mouseReleased(RVB_UPDATE),F=new p5.Filter,polySynth.disconnect(),polySynth.connect(F),F.setType("lowpass"),F.set(5e3,10),F.freq(filter_envelope),filter_envelope.aLevel=depth,F.disconnect(),RVB=new p5.Reverb,DLY=new p5.Delay,DLY.process(F),RVB.process(DLY),DLY.disconnect(),F.connect(RVB),DLY.connect(RVB),DLY_UPDATE(),RVB_UPDATE(),noLoop()}function initialize(e){for(var t=0;t<gridnumx;t++)for(var o=0;o<gridnumy;o++)e[o][t]=!0;return e}function draw(){clear(),translate(-width/2,-height/2),rectMode(CENTER),ystep=100/y.length,xstep=100/x.length,background(10,0,10),textSize(15),H=windowHeight,W=windowWidth,fill(255),text("Release",row2hor-offset,H-30*Hstep),text("Sustain",row2hor-offset,H-50*Hstep),text("Decay",row2hor-offset,H-70*Hstep),text("Attack",row2hor-offset,H-90*Hstep),fill(255,50,100),text("Amp Envelope",row2hor-offset,H-120*Hstep),text("Filter Env",row3hor-offset,H-120*Hstep),fill(255),text("Depth",row3hor-offset,H-10*Hstep),text("Release",row3hor-offset,H-30*Hstep),text("Sustain",row3hor-offset,H-50*Hstep),text("Decay",row3hor-offset,H-70*Hstep),text("Attack",row3hor-offset,H-90*Hstep),fill(255,50,100),text("Wave Type",row4hor-offset/2,H-120*Hstep),text("Fund (Hz)",row4hor-offset/2,H-58*Hstep),fill(255),text("Time",row5hor-offset,H-70*Hstep),text("FB",row5hor-offset,H-90*Hstep),text("(Right)",row5hor-offset,H-30*Hstep),text("(Left)",row5hor-offset,H-50*Hstep),fill(255,50,100),text("Delay",row5hor-offset,H-120*Hstep),text("Reverb",row6hor,H-120*Hstep),fill(255),text("Depth",row6hor-offset,H-50*Hstep),text("Decay",row6hor-offset,H-70*Hstep),text("Time",row6hor-offset,H-90*Hstep),fill(255,50,100),text("Cardinality",row1hor,bottom-70*Hstep),text("Harmonicity",row1hor,bottom-17*Hstep),text("Metaharm",row1hor,bottom+38*Hstep),keyIsDown(LEFT_ARROW)&&(r=F.res(),F.res(r-1)),keyIsDown(RIGHT_ARROW)&&(r=F.res(),F.res(r+1)),keyIsDown(UP_ARROW)&&(F.biquad.frequency.value+=50),keyIsDown(DOWN_ARROW)&&(F.biquad.frequency.value-=50),stroke("white"),strokeWeight(4),lineX=W-W/20,startY=10,endY=H-10,Ylen=H-20,textSize(15),p1=startY+Ylen/4,p2=startY+Ylen/2,p3=startY+3*Ylen/4,line(lineX,startY,lineX,endY),line(lineX-10,startY,lineX+10,startY),text("4",lineX-30,startY+5),line(lineX-10,p1,lineX+10,p1),text("3",lineX-30,p1+5),line(lineX-10,p2,lineX+10,p2),text("2",lineX-30,p2+5),line(lineX-10,p3,lineX+10,p3),text("1",lineX-30,p3+5),line(lineX-10,endY,lineX+10,endY),text("0",lineX-30,endY+5),text("Octave",lineX-25,endY+20),strokeWeight(1);for(var e=0;e<y.length;e++)for(var t=0;t<x.length;t++){keyIsPressed||(col=initialize(col));var o=e*j_mult+t*i_mult;filler=[150+xstep*t,80,100+ystep*e],inv_filler=[155-xstep*t,135-ystep*e/2,250],col[y.length-e-1][t]?(fill(filler),ellipse(x[t]+keyboardscaling*(4-e),y[y.length-e-1],w,w)):(fill("black"),ellipse(x[t]+keyboardscaling*(4-e),y[y.length-e-1],w,w),strokeWeight(5),stroke(250,0,158),Yloc=Ylen-(startY+o/getValue()*(Ylen/4))+20,line(lineX-10,Yloc,lineX+15,Yloc),strokeWeight(1),stroke(255)),textSize(20),fill(inv_filler),text(o,x[t]-w/8+keyboardscaling*(4-e),y[y.length-e-1]+w/8)}}function RVB_UPDATE(){RVB.drywet(RVBDRYWET.value()),RVB.set(RVBtime.value(),RVBDecay.value())}function DLY_UPDATE(){DLY.process(F,DLYtime.value(),DLYFB.value()),"pingPong"==DLYtype&&(DLY.rightDelay.delayTime.value=DLYright.value(),DLY.leftDelay.delayTime.value=DLYleft.value())}function DLYflip(){0==DLYtype?(DLYtype="pingPong",DLYbutton.style("background-color",color(25,23,200,50)),DLY.rightDelay.delayTime.value=DLYright.value(),DLY.leftDelay.delayTime.value=DLYleft.value()):(DLYtype=0,DLY.setType(0),DLYbutton.style("background-color",color("white")),DLY.rightDelay.delayTime.value=DLYtime.value(),DLY.leftDelay.delayTime.value=DLYtime.value())}function fund_update(){fund=int(fundamental.elt.value)}function fenvflip(){fenv_is_on=!fenv_is_on,fenv_is_on&&fenvbutton.style("background-color",color("white")),fenv_is_on||fenvbutton.style("background-color",color(25,23,200,50))}function getValue(){return val=int(N.value()),isNaN(val)&&(val=12),val}function amp_env(){polySynth.setADSR(ATTACK.value(),DECAY.value(),SUSTAIN.value(),RELEASE.value()),console.log("ADSR set")}function fenv(){filter_envelope.setADSR(fATTACK.value(),fDECAY.value(),fSUSTAIN.value(),fRELEASE.value()),filter_envelope.setRange(fLEVEL.value(),0)}function update_wave(){for(var e=0;e<polySynth.audiovoices.length;e++)polySynth.audiovoices[e].oscillator.setType(WAVE.selected())}function fastfactor(e){let t=[];for(;e%2==0;)e/=2,append(t,2);for(var o=3;o<=e;o+=2)for(;e%o==0;)append(t,o),e/=o;return t=[...new Set(t)],t}function powerlist(e){for(out=[],n=getValue()/2,i=0;i<e.length;i++){for(tmp=e[i],j=1,out_ni=[];pow(tmp,j)<n;)append(out_ni,pow(tmp,j)),j++;append(out,out_ni)}return out}function reloadfunc(){reload=!0}function monte(e){return Iguess=round(random(0,e.length-1)),Jguess=round(random(0,e.length-1)),Iguess==Jguess&&([Iguess,Jguess]=monte()),[Iguess,Jguess]}function frqcalc(e,t){return power_list=powerlist(fastfactor(getValue())),3==power_list.length&&(power_list=metaheuristic(power_list),reload=!0),reload=!(3<power_list.length)||(reload&&([Iguess,Jguess]=monte(power_list)),power_list=invoke_the_monte_carlo_method(Iguess,Jguess,power_list),!1),[j_mult,i_mult]=heuristic(power_list),i_mult>j_mult&&(tmp=j_mult,j_mult=i_mult,i_mult=tmp,console.log("swap")),fund*pow(2,(-j_mult*e+i_mult*t)/getValue())}function heuristic(e){if(2==e.length)return selector=harmonicity.elt.selectedIndex,i_arr=e[0],j_arr=e[1],0==selector&&(j_out=j_arr[0],i_out=i_arr[0]),1==selector&&(j_out=j_arr[floor((j_arr.length-1)/2)],i_out=i_arr[floor((i_arr.length-1)/2)]),2==selector&&(j_out=j_arr[j_arr.length-1],i_out=i_arr[i_arr.length-1]),[j_out,i_out]}function metaheuristic(e){return selector=metaharmonicity.elt.selectedIndex,0==selector&&(j_out=e[1],i_out=e[0]),1==selector&&(j_out=e[2],i_out=e[1]),2==selector&&(j_out=e[2],i_out=e[0]),[i_out,j_out]}function invoke_the_monte_carlo_method(e,t,o){return console.log(o.length),j_out=o[t],i_out=o[e],[i_out,j_out]}function keyPressed(){return"ArrowLeft"==key?(r=F.res(),F.res(r-1),void loop()):"ArrowRight"==key?(r=F.res(),F.res(r+1),void loop()):"ArrowUp"==key?(F.biquad.frequency.value+=50,void loop()):"ArrowDown"==key?(F.biquad.frequency.value-=50,void loop()):void(" "!=key?(fenv_is_on&&filter_envelope.triggerAttack(),arr=locate_key(key),key_x=arr[0],key_y=arr[1],keystates[key_y][key_x]=1,col[key_y][key_x]=!col[key_y][key_x],l=active_notes.length,i=key_x,j=key_y,frqtotest=frqcalc(j,i),polySynth.noteAttack(frqtotest),console.log(polySynth.notes),redraw()):filter_envelope.triggerAttack())}function keyReleased(){if(" "!=key)if(fenv_is_on&&filter_envelope.triggerRelease(),"ArrowLeft"!=key)if("ArrowRight"!=key)if("ArrowUp"!=key)if("ArrowDown"!=key){if(arr=locate_key(key),key_x=arr[0],key_y=arr[1],col[key_y][key_x]=!col[key_y][key_x],i=key_x,j=key_y,!keyIsPressed)return polySynth.noteRelease(),active_notes=[],clear_all(),noLoop(),void redraw();1==keystates[key_y][key_x]&&(keystates[key_y][key_x]=0,i=key_x,j=key_y,frqtotest=frqcalc(j,i)),polySynth.noteRelease(frqtotest),console.log(polySynth.notes),redraw()}else noLoop();else noLoop();else noLoop();else noLoop();else filter_envelope.triggerRelease()}function mod(e,t){return(e%t+t)%t}function locate_key(e){let t,o;for(var r=0;r<=3;r++)keygrid[r].includes(e)&&(t=r);return o=keygrid[t].indexOf(e),[o,t]}function get_notes(){notearr=[];for(var e=0;e<=3;e++){jmax=keygrid[e].length;for(var t=0;t<jmax;t++)1==keystates[e][t]&&append(notearr,[e,t])}return notearr}function clear_all(){notearr=[];for(var e=0;e<=3;e++){jmax=keygrid[e].length;for(var t=0;t<jmax;t++)keystates[e][t]=0}}col=[[],[],[],[]];