var w,col,x=[],y=[];let yscale=.55,xscale=.8,fund=220,N,monoSynth,polySynth,EDO;EDO=12;let active_notes=[],place1=150,gridnumx=12,gridnumy=4,keyboardscaling=25,filter_envelope=new p5.Envelope,metaharmonicity,harmonicity,fenv_is_on=!0,depth=1e3,j_mult=4,i_mult=3,fundamental,RVB,DLY,DLYtype=0,Font,reload,Iguess,Jguess;function preload(){Font=loadFont("Assets/OSANS.ttf")}let keygrid=[["1","2","3","4","5","6","7","8","9","0","-","="],["q","w","e","r","t","y","u","i","o","p","[","]"],["a","s","d","f","g","h","j","k","l",";","'","Enter"],["z","x","c","v","b","n","m",",",".","/"]],keystates=[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]];function setup(){col=initialize(col),createCanvas(windowWidth,windowHeight,WEBGL),textFont(Font),w=windowWidth/23,offset=w/8;for(var e=0;e<gridnumy;e++)for(var t=0;t<gridnumx;t++)x[t]=(w+t*w)/xscale+offset,y[e]=(w+e*w)/yscale;monoSynth=new p5.MonoSynth("sawtooth"),polySynth=new p5.PolySynth,polySynth.AudioVoice=monoSynth,userStartAudio(),translate(-width/2,-height/2),H=windowHeight,Hstep=H/792,W=windowWidth,Wstep=W/1536,Nx=20,Ny=windowHeight-windowHeight/10,N=createInput("Cardinality"),N.position(Nx,Ny-58*Hstep),N.size(70),N.elt.value=12,ent=createButton("Load"),ent.position(Nx+30,Ny-58*Hstep),ent.mousePressed(reloadfunc),fundamental=createInput(""),fundamental.position(place1*Wstep+225*Wstep+240*Wstep,Ny+35*Hstep),fundamental.size(70),fundamental.elt.value=fund,fundamental.input(fund_update),slidersize=windowWidth/12,slider_width=slidersize.toString()+"px",selectwidth=windowWidth/20,select_width=selectwidth.toString()+"px",harmonicity=createSelect("HARMONICITY"),harmonicity.option("Scalar"),harmonicity.option("Intermediate"),harmonicity.option("Chordal"),harmonicity.selected="Chordal",harmonicity.style("width",select_width),harmonicity.position(Nx,Ny+2*Hstep),metaharmonicity=createSelect("METAHARMONICITY"),metaharmonicity.option("Scalar (1&2)"),metaharmonicity.option("Inter (2&3)"),metaharmonicity.option("Chordal (1&3)"),metaharmonicity.selected="Inter (2&3)",metaharmonicity.style("width",select_width),metaharmonicity.position(Nx,Ny+50*Hstep),fill("white"),fATTACK=createSlider(0,5,.5,.1),fATTACK.position(450*Wstep,H-105*Hstep),fATTACK.style("width",slider_width),fATTACK.mouseReleased(fenv),fDECAY=createSlider(0,5,1,.1),fDECAY.position(450*Wstep,H-85*Hstep),fDECAY.style("width",slider_width),fDECAY.mouseReleased(fenv),fSUSTAIN=createSlider(0,1,1,.1),fSUSTAIN.position(450*Wstep,H-65*Hstep),fSUSTAIN.style("width",slider_width),fSUSTAIN.mouseReleased(fenv),fRELEASE=createSlider(0,5,1.5,.1),fRELEASE.position(450*Wstep,H-45*Hstep),fRELEASE.style("width",slider_width),fRELEASE.mouseReleased(fenv),fLEVEL=createSlider(0,3e3,1e3,100),fLEVEL.position(450*Wstep,H-25*Hstep),fLEVEL.style("width",slider_width),fLEVEL.mouseReleased(fenv),FXwidth=(slidersize-W/50).toString()+"px",RVBtime=createSlider(0,10,5,.1),RVBtime.position(1e3*Wstep-20,H-105*Hstep),RVBtime.style("width",FXwidth),RVBtime.mouseReleased(RVB_UPDATE),RVBDecay=createSlider(1,10,2,.1),RVBDecay.position(1e3*Wstep-20,H-85*Hstep),RVBDecay.style("width",FXwidth),RVBDecay.mouseReleased(RVB_UPDATE),RVBDRYWET=createSlider(0,1,0,.05),RVBDRYWET.position(1e3*Wstep-20,H-65*Hstep),RVBDRYWET.style("width",FXwidth),RVBDRYWET.mouseReleased(RVB_UPDATE),DLYFB=createSlider(0,.99,0,.01),DLYFB.position(800*Wstep-20,H-105*Hstep),DLYFB.style("width",FXwidth),DLYFB.mouseReleased(DLY_UPDATE),DLYtime=createSlider(0,.99,.5,.01),DLYtime.position(800*Wstep-20,H-85*Hstep),DLYtime.style("width",FXwidth),DLYtime.mouseReleased(DLY_UPDATE),DLYleft=createSlider(0,.99,.5,.01),DLYleft.position(800*Wstep-20,H-65*Hstep),DLYleft.style("width",FXwidth),DLYleft.mouseReleased(DLY_UPDATE),DLYright=createSlider(0,.99,.5,.01),DLYright.position(800*Wstep-20,H-45*Hstep),DLYright.style("width",FXwidth),DLYright.mouseReleased(DLY_UPDATE),ATTACK=createSlider(0,5,.5,.1),ATTACK.position(220*Wstep,H-90*Hstep),ATTACK.style("width",slider_width),ATTACK.mouseReleased(env),DECAY=createSlider(0,5,1,.1),DECAY.position(220*Wstep,H-70*Hstep),DECAY.style("width",slider_width),DECAY.mouseReleased(env),SUSTAIN=createSlider(0,1,1,.1),SUSTAIN.position(220*Wstep,H-50*Hstep),SUSTAIN.style("width",slider_width),SUSTAIN.mouseReleased(env),RELEASE=createSlider(0,5,1.5,.1),RELEASE.position(220*Wstep,H-30*Hstep),RELEASE.style("width",slider_width),RELEASE.mouseReleased(env),WAVE=createSelect("WAVE"),WAVE.option("sine"),WAVE.option("triangle"),WAVE.option("sawtooth"),WAVE.option("square"),WAVE.position(place1*Wstep+225*Wstep+240*Wstep,H-105*Hstep),WAVE.changed(update_wave),WAVE.selected("triangle"),F=new p5.Filter,polySynth.disconnect(),polySynth.connect(F),F.setType("lowpass"),F.set(5e3,10),F.freq(filter_envelope),filter_envelope.aLevel=depth,F.disconnect(),RVB=new p5.Reverb,DLY=new p5.Delay,DLYbutton=createButton("Mono/Stereo"),DLYbutton.position(800*Wstep,H-137*Hstep),DLYbutton.mousePressed(DLYflip),DLY.process(F),RVB.process(DLY),DLY.disconnect(),F.connect(RVB),DLY.connect(RVB),DLY_UPDATE(),RVB_UPDATE(),fenvbutton=createButton("On/Off"),fenvbutton.position(place1*Wstep+225*Wstep+120,H-137*Hstep),fenvbutton.mousePressed(fenvflip),noLoop()}function initialize(e){for(var t=0;t<gridnumx;t++)for(var i=0;i<gridnumy;i++)e[i][t]=!0;return e}function draw(){clear(),translate(-width/2,-height/2),rectMode(CENTER),ystep=100/y.length,xstep=100/x.length,background(10,0,10),textSize(15),H=windowHeight,Hstep=H/792,W=windowWidth,Wstep=W/1536,fill(255),text("Release",place1*Wstep,H-15*Hstep),text("Sustain",place1*Wstep,H-35*Hstep),text("Decay",place1*Wstep,H-55*Hstep),text("Attack",place1*Wstep,H-75*Hstep),text("Depth",place1*Wstep+225*Wstep,H-10*Hstep),text("Release",place1*Wstep+225*Wstep,H-30*Hstep),text("Sustain",place1*Wstep+225*Wstep,H-50*Hstep),text("Decay",place1*Wstep+225*Wstep,H-70*Hstep),text("Attack",place1*Wstep+225*Wstep,H-90*Hstep),text("Depth",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-50*Hstep),text("Decay",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-70*Hstep),text("Time",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-90*Hstep),text("Time",place1*Wstep+225*Wstep+345*Wstep,H-70*Hstep),text("FB",place1*Wstep+225*Wstep+345*Wstep,H-90*Hstep),text("(Right)",place1*Wstep+225*Wstep+345*Wstep,H-30*Hstep),text("(Left)",place1*Wstep+225*Wstep+345*Wstep,H-50*Hstep),fill(255,50,100),text("Amp Envelope",place1*Wstep,H-100*Hstep),text("Filter Envelope",place1*Wstep+225*Wstep,H-120*Hstep),text("Reverb",place1*Wstep+225*Wstep+345*Wstep+200*Wstep,H-120*Hstep),text("Delay",place1*Wstep+225*Wstep+345*Wstep,H-120*Hstep),text("Cardinality",Nx,H-120),text("Harmonicity",Nx,H-73),text("Metaharm",Nx,H-30),text("Wave Type",place1*Wstep+225*Wstep+235*Wstep,H-120*Hstep),text("Fund (Hz)",place1*Wstep+225*Wstep+235*Wstep,H-58*Hstep),keyIsDown(LEFT_ARROW)&&(r=F.res(),F.res(r-1)),keyIsDown(RIGHT_ARROW)&&(r=F.res(),F.res(r+1)),keyIsDown(UP_ARROW)&&(F.biquad.frequency.value+=50),keyIsDown(DOWN_ARROW)&&(F.biquad.frequency.value-=50),stroke("white"),strokeWeight(4),lineX=1400*Wstep,startY=50*Hstep,endY=750*Hstep,Ylen=750*Hstep-50*Hstep,textSize(15),p1=startY+Ylen/4,p2=startY+Ylen/2,p3=startY+3*Ylen/4,line(lineX,startY,lineX,endY),line(lineX-10,startY,lineX+10,startY),text("4",lineX-30,startY+5),line(lineX-10,p1,lineX+10,p1),text("3",lineX-30,p1+5),line(lineX-10,p2,lineX+10,p2),text("2",lineX-30,p2+5),line(lineX-10,p3,lineX+10,p3),text("1",lineX-30,p3+5),line(lineX-10,endY,lineX+10,endY),text("0",lineX-30,endY+5),text("Octave",lineX-25,endY+20),strokeWeight(1);for(var e=0;e<y.length;e++)for(var t=0;t<x.length;t++){keyIsPressed||(col=initialize(col));var i=e*j_mult+t*i_mult;filler=[150+xstep*t,80,100+ystep*e],inv_filler=[155-xstep*t,135-ystep*e/2,250],col[y.length-e-1][t]?(fill(filler),ellipse(x[t]+keyboardscaling*(4-e),y[y.length-e-1],w,w)):(fill("black"),ellipse(x[t]+keyboardscaling*(4-e),y[y.length-e-1],w,w),strokeWeight(5),stroke(250,0,158),Yloc=i/getValue()*(Ylen/4),line(lineX-10,endY-Yloc*Hstep,lineX+15,endY-Yloc*Hstep),strokeWeight(1),stroke(255)),textSize(20),fill(inv_filler),text(i,x[t]-w/8+keyboardscaling*(4-e),y[y.length-e-1]+w/8)}}function RVB_UPDATE(){RVB.drywet(RVBDRYWET.value()),RVB.set(RVBtime.value(),RVBDecay.value())}function DLY_UPDATE(){DLY.process(F,DLYtime.value(),DLYFB.value()),"pingPong"==DLYtype&&(DLY.rightDelay.delayTime.value=DLYright.value(),DLY.leftDelay.delayTime.value=DLYleft.value())}function DLYflip(){0==DLYtype?(DLYtype="pingPong",DLYbutton.style("background-color",color(25,23,200,50)),DLY.rightDelay.delayTime.value=DLYright.value(),DLY.leftDelay.delayTime.value=DLYleft.value()):(DLYtype=0,DLY.setType(0),DLYbutton.style("background-color",color("white")),DLY.rightDelay.delayTime.value=DLYtime.value(),DLY.leftDelay.delayTime.value=DLYtime.value())}function fund_update(){fund=int(fundamental.elt.value)}function fenvflip(){fenv_is_on=!fenv_is_on,fenv_is_on&&fenvbutton.style("background-color",color("white")),fenv_is_on||fenvbutton.style("background-color",color(25,23,200,50))}function getValue(){return val=int(N.value()),isNaN(val)&&(val=12),val}function env(){polySynth.setADSR(ATTACK.value(),DECAY.value(),SUSTAIN.value(),RELEASE.value())}function fenv(){filter_envelope.setADSR(fATTACK.value(),fDECAY.value(),fSUSTAIN.value(),fRELEASE.value()),filter_envelope.setRange(fLEVEL.value(),0)}function update_wave(){for(var e=0;e<polySynth.audiovoices.length;e++)polySynth.audiovoices[e].oscillator.setType(WAVE.selected())}function fastfactor(e){let t=[];for(;e%2==0;)e/=2,append(t,2);for(var i=3;i<=e;i+=2)for(;e%i==0;)append(t,i),e/=i;return t=[...new Set(t)],t}function powerlist(e){for(out=[],n=getValue()/2,i=0;i<e.length;i++){for(tmp=e[i],j=1,out_ni=[];pow(tmp,j)<n;)append(out_ni,pow(tmp,j)),j++;append(out,out_ni)}return out}function reloadfunc(){reload=!0}function monte(e){return Iguess=round(random(0,e.length-1)),Jguess=round(random(0,e.length-1)),Iguess==Jguess&&([Iguess,Jguess]=monte()),[Iguess,Jguess]}function frqcalc(e,t){return power_list=powerlist(fastfactor(getValue())),3==power_list.length&&(power_list=metaheuristic(power_list),reload=!0),reload=!(3<power_list.length)||(reload&&([Iguess,Jguess]=monte(power_list)),power_list=invoke_the_monte_carlo_method(Iguess,Jguess,power_list),!1),[j_mult,i_mult]=heuristic(power_list),fund*pow(2,(-j_mult*e+i_mult*t)/getValue())}function heuristic(e){if(2==e.length)return selector=harmonicity.elt.selectedIndex,i_arr=e[0],j_arr=e[1],0==selector&&(j_out=j_arr[0],i_out=i_arr[0]),1==selector&&(j_out=j_arr[floor((j_arr.length-1)/2)],i_out=i_arr[floor((i_arr.length-1)/2)]),2==selector&&(j_out=j_arr[j_arr.length-1],i_out=i_arr[i_arr.length-1]),[j_out,i_out]}function metaheuristic(e){return selector=metaharmonicity.elt.selectedIndex,0==selector&&(j_out=e[1],i_out=e[0]),1==selector&&(j_out=e[2],i_out=e[1]),2==selector&&(j_out=e[2],i_out=e[0]),[i_out,j_out]}function invoke_the_monte_carlo_method(e,t,i){return console.log(i.length),j_out=i[t],i_out=i[e],[i_out,j_out]}function keyPressed(){return"ArrowLeft"==key?(r=F.res(),F.res(r-1),void loop()):"ArrowRight"==key?(r=F.res(),F.res(r+1),void loop()):"ArrowUp"==key?(F.biquad.frequency.value+=50,void loop()):"ArrowDown"==key?(F.biquad.frequency.value-=50,void loop()):void(" "!=key?(fenv_is_on&&filter_envelope.triggerAttack(),arr=locate_key(key),key_x=arr[0],key_y=arr[1],keystates[key_y][key_x]=1,col[key_y][key_x]=!col[key_y][key_x],l=active_notes.length,i=key_x,j=key_y,frqtotest=frqcalc(j,i),polySynth.noteAttack(frqtotest),console.log(polySynth.notes),redraw()):filter_envelope.triggerAttack())}function keyReleased(){if(" "!=key)if(fenv_is_on&&filter_envelope.triggerRelease(),"ArrowLeft"!=key)if("ArrowRight"!=key)if("ArrowUp"!=key)if("ArrowDown"!=key){if(arr=locate_key(key),key_x=arr[0],key_y=arr[1],col[key_y][key_x]=!col[key_y][key_x],i=key_x,j=key_y,!keyIsPressed)return polySynth.noteRelease(),active_notes=[],clear_all(),noLoop(),void redraw();1==keystates[key_y][key_x]&&(keystates[key_y][key_x]=0,i=key_x,j=key_y,frqtotest=frqcalc(j,i)),polySynth.noteRelease(frqtotest),console.log(polySynth.notes),redraw()}else noLoop();else noLoop();else noLoop();else noLoop();else filter_envelope.triggerRelease()}function mod(e,t){return(e%t+t)%t}function locate_key(e){let t,i;for(var o=0;o<=3;o++)keygrid[o].includes(e)&&(t=o);return i=keygrid[t].indexOf(e),[i,t]}function get_notes(){notearr=[];for(var e=0;e<=3;e++){jmax=keygrid[e].length;for(var t=0;t<jmax;t++)1==keystates[e][t]&&append(notearr,[e,t])}return notearr}function clear_all(){notearr=[];for(var e=0;e<=3;e++){jmax=keygrid[e].length;for(var t=0;t<jmax;t++)keystates[e][t]=0}}col=[[],[],[],[]];